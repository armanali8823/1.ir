<!DOCTYPE html>  
<html lang="fa">  
<head>  
  <meta charset="utf-8" />  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <title>Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ - Ø³Ø§Ù…Ø§Ù†Ù‡ Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</title>  
  <style>  
    body {  
      font-family: Tahoma, sans-serif;  
      direction: rtl;  
      background-color: #f0f0f0;  
      padding: 20px;  
      text-align: center;  
    }  
    h2 { margin-bottom: 10px; }  
    .controls {  
      max-width: 900px;  
      margin: 12px auto;  
      display:flex;  
      gap:8px;  
      align-items:center;  
      justify-content:center;  
      flex-wrap:wrap;  
    }  
    input[type="text"], select {  
      padding:8px 10px;  
      border-radius:6px;  
      border:1px solid #ccc;  
      font-size:14px;  
      text-align:center;  
    }  
    button {  
      padding:8px 12px;  
      border-radius:6px;  
      border:none;  
      cursor:pointer;  
      background:#2196f3;  
      color:white;  
      user-select:none;  
    }  
    button.danger { background:#e53935; }  
    button.secondary { background:#607d8b; }  
    table {  
      width: 100%;  
      border-collapse: collapse;  
      background: white;  
      margin-top: 16px;  
      max-width: 900px;  
      margin-left:auto;  
      margin-right:auto;  
    }  
    th, td {  
      border: 1px solid #ddd;  
      padding: 8px;  
      font-size: 13px;  
      text-align: center;  
    }  
    th { background:#eee; }  
    .small {  
      font-size:12px;  
      padding:6px 8px;  
    }  
    .actions button {  
      margin:2px;  
      padding:6px 8px;  
      border-radius:5px;  
      font-size:12px;  
    }  
    .no-data {  
      color:#666;  
      margin-top: 30px;  
    }  
    .top-row {  
      display:flex;  
      justify-content:center;  
      gap:12px;  
      align-items:center;  
      max-width:900px;  
      margin:0 auto 6px auto;  
    }  
    a.back {  
      display:inline-block;  
      margin-top:10px;  
      text-decoration:none;  
      color:#333;  
      background:white;  
      padding:8px 12px;  
      border-radius:6px;  
      box-shadow:0 1px 4px rgba(0,0,0,0.08);  
    }  
    @media (max-width:760px){  
      table, .controls { width: 100%; }  
      th, td { font-size:12px; padding:6px; }  
    }  
    #backBtn {  
      margin-bottom: 15px;  
      padding: 6px 12px;  
      font-size: 14px;  
      border-radius: 6px;  
      border: 1px solid #ccc;  
      cursor: pointer;  
      background-color: #;  
      user-select: none; 
    }  
    #backBtn:hover {  
      background-color: #ddd;  
    }  
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª ØªØ§Ø±ÛŒØ® Ú©Ù†Ø§Ø± input */  
    #registerDateBtn {  
      width: 70px;  
      margin-right: 10px;  
      vertical-align: middle;  
    }  
  </style>    <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ SheetJS Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Excel -->    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>  </head>  
<body>  
    <a href="1.html"><button id="backBtn" onclick="history.back()">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>  
</a>  
  <h2>ğŸ“… Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>    <div class="controls">  
    <input type="text" id="filterDate" placeholder="Ù…Ø«Ø§Ù„: 1404/05/17 ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡" />  
    <button id="btnFilter">ğŸ” ÙÛŒÙ„ØªØ±</button>  
    <select id="dateSelect" style="min-width:220px;">  
      <option value="">â¤ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ø§Ø² ÙÙ‡Ø±Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>  
    </select>  
    <button id="btnShowAll" class="secondary">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡</button>  
    <button id="btnExport">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ Excel</button>  
  </div>    <div class="top-row">  
    <a href="hozur.html" class="back">â—€ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</a>  
    <button id="btnClearAll" class="danger" title="Ø­Ø°Ù Ù‡Ù…Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§">Ø­Ø°Ù Ù‡Ù…Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>  
  </div>    <div id="tableContainer"></div>    <div id="noData" class="no-data" style="display:none;">Ù‡ÛŒÚ† Ú¯Ø²Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>  <script>  
  // Ø³Ø§Ø®ØªØ§Ø± attendanceHistory Ø¯Ø± localStorage: { "1404/05/17": [ {name,job,enter,exit,status}, ... ], "1404/05/18": [...] }  
  function readHistory() {  
    try {  
      return JSON.parse(localStorage.getItem('attendanceHistory')) || {};  
    } catch (e) {  
      return {};  
    }  
  }  
  
  function saveHistory(history) {  
    localStorage.setItem('attendanceHistory', JSON.stringify(history));  
  }  
  
  function buildDateSelect(history) {  
    const sel = document.getElementById('dateSelect');  
    sel.innerHTML = '<option value="">â¤ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ø§Ø² ÙÙ‡Ø±Ø³Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>';  
    const dates = Object.keys(history).sort().reverse();  
    dates.forEach(d => {  
      const opt = document.createElement('option');  
      opt.value = d;  
      opt.textContent = d + ' (' + history[d].length + ' Ø±Ú©ÙˆØ±Ø¯)';  
      sel.appendChild(opt);  
    });  
  }  
  
  function renderTable(filterDate = '') {  
    const history = readHistory();  
    const container = document.getElementById('tableContainer');  
    container.innerHTML = '';  
    const allDates = Object.keys(history).sort().reverse();  
  
    let rows = [];  
    if (filterDate) {  
      if (history[filterDate]) {  
        history[filterDate].forEach((emp, idx) => rows.push({ date: filterDate, index: idx, emp }));  
      }  
    } else {  
      // Ù‡Ù…Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§  
      allDates.forEach(date => {  
        history[date].forEach((emp, idx) => rows.push({ date, index: idx, emp }));  
      });  
    }  
  
    if (rows.length === 0) {  
      document.getElementById('noData').style.display = 'block';  
      return;  
    } else {  
      document.getElementById('noData').style.display = 'none';  
    }  
  
    // Ø¬Ø¯ÙˆÙ„  
    let html = `<table><thead><tr>  
      <th>Ø±Ø¯ÛŒÙ</th>  
      <th>ØªØ§Ø±ÛŒØ®</th>  
      <th>Ù†Ø§Ù…</th>  
      <th>Ø´ØºÙ„</th>  
      <th>ÙˆØ±ÙˆØ¯</th>  
      <th>Ø®Ø±ÙˆØ¬</th>  
      <th>ÙˆØ¶Ø¹ÛŒØª</th>  
      <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>  
    </tr></thead><tbody>`;  
  
    rows.forEach((r, i) => {  
      const e = r.emp;  
      html += `<tr data-date="${r.date}" data-idx="${r.index}">  
        <td>${i+1}</td>  
        <td>${r.date}</td>  
        <td contenteditable="true" class="editable name">${escapeHtml(e.name)}</td>  
        <td contenteditable="true" class="editable job">${escapeHtml(e.job)}</td>  
        <td contenteditable="true" class="editable enter">${escapeHtml(e.enter)}</td>  
        <td contenteditable="true" class="editable exit">${escapeHtml(e.exit)}</td>  
        <td>  
          <select class="status-select small">  
            <option value="">--</option>  
            <option value="present" ${e.status === 'present' ? 'selected' : ''}>Ø­Ø§Ø¶Ø±</option>  
            <option value="absent" ${e.status === 'absent' ? 'selected' : ''}>ØºØ§ÛŒØ¨</option>  
          </select>  
        </td>  
        <td class="actions">  
          <button class="small" onclick="saveRow(this)">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>  
          <button class="small" onclick="deleteRow(this)">ğŸ—‘ Ø­Ø°Ù</button>  
        </td>  
      </tr>`;  
    });  
  
    html += '</tbody></table>';  
    container.innerHTML = html;  
  }  
  
  // Ù…Ø­Ø§ÙØ¸ Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± XSS Ù†Ù…Ø§ÛŒØ´ÛŒ  
  function escapeHtml(s) {  
    if (s === undefined || s === null) return '';  
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });  
  }  
  
  // Ø°Ø®ÛŒØ±Ù‡ ÛŒÚ© Ø±Ø¯ÛŒÙ Ù¾Ø³ Ø§Ø² ÙˆÛŒØ±Ø§ÛŒØ´  
  function saveRow(btn) {  
    const tr = btn.closest('tr');  
    const date = tr.getAttribute('data-date');  
    const idx = Number(tr.getAttribute('data-idx'));  
    const history = readHistory();  
    if (!history[date]) return alert('ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.');  
  
    const name = tr.querySelector('.name').textContent.trim();  
    const job = tr.querySelector('.job').textContent.trim();  
    const enter = tr.querySelector('.enter').textContent.trim();  
    const exit = tr.querySelector('.exit').textContent.trim();  
    const status = tr.querySelector('.status-select').value;  
  
    if (!name || !job) return alert('Ù†Ø§Ù… Ùˆ Ø´ØºÙ„ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯.');  
  
    history[date][idx] = { name, job, enter, exit, status };  
    saveHistory(history);  
    buildDateSelect(history);  
    alert('âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');  
    // Ø±ÙØ±Ø´ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ Ù‡Ù…Ø§Ù† ÙÛŒÙ„ØªØ± ÙØ¹Ù„ÛŒ  
    const filterVal = document.getElementById('filterDate').value.trim();  
    renderTable(filterVal);  
  }  
  
  // Ø­Ø°Ù ÛŒÚ© Ø±Ø¯ÛŒÙ  
  function deleteRow(btn) {  
    if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;  
    const tr = btn.closest('tr');  
    const date = tr.getAttribute('data-date');  
    const idx = Number(tr.getAttribute('data-idx'));  
    const history = readHistory();  
    if (!history[date]) return;  
    history[date].splice(idx, 1);  
    if (history[date].length === 0) delete history[date];  
    saveHistory(history);  
    buildDateSelect(history);  
    const filterVal = document.getElementById('filterDate').value.trim();  
    renderTable(filterVal);  
  }  
  
  // Ø­Ø°Ù Ù‡Ù…Ù‡  
  document.getElementById('btnClearAll').addEventListener('click', () => {  
    if (!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.')) return;  
    localStorage.removeItem('attendanceHistory');  
    buildDateSelect({});  
    renderTable();  
  });  
  
  // ÙÛŒÙ„ØªØ±  
  document.getElementById('btnFilter').addEventListener('click', () => {  
    const v = document.getElementById('filterDate').value.trim();  
    renderTable(v);  
  });  
  
  // Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡  
  document.getElementById('btnShowAll').addEventListener('click', () => {  
    document.getElementById('filterDate').value = '';  
    renderTable();  
  });  
  
  // Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ù„ÛŒØ³Øª  
  document.getElementById('dateSelect').addEventListener('change', (e) => {  
    const v = e.target.value;  
    document.getElementById('filterDate').value = v;  
    renderTable(v);  
  });  
  
  // Ø®Ø±ÙˆØ¬ÛŒ Excel Ø§Ø² Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø¬Ø¯ÙˆÙ„  
  document.getElementById('btnExport').addEventListener('click', () => {  
    const filterVal = document.getElementById('filterDate').value.trim();  
    const history = readHistory();  
    let rows = [];  
    if (filterVal) {  
      if (!history[filterVal]) return alert('Ù‡ÛŒÚ† Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');  
      history[filterVal].forEach(emp => rows.push({ ØªØ§Ø±ÛŒØ®: filterVal, Ù†Ø§Ù…: emp.name, Ø´ØºÙ„: emp.job, ÙˆØ±ÙˆØ¯: emp.enter, Ø®Ø±ÙˆØ¬: emp.exit, ÙˆØ¶Ø¹ÛŒØª: emp.status || '' }));  
    } else {  
      Object.keys(history).sort().forEach(date => {  
        history[date].forEach(emp => rows.push({ ØªØ§Ø±ÛŒØ®: date, Ù†Ø§Ù…: emp.name, Ø´ØºÙ„: emp.job, ÙˆØ±ÙˆØ¯: emp.enter, Ø®Ø±ÙˆØ¬: emp.exit, ÙˆØ¶Ø¹ÛŒØª: emp.status || '' }));  
      });  
    }  
    if (rows.length === 0) return alert('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');  
  
    // Ø³Ø§Ø®Øª ÙˆØ±Ú©â€ŒØ¨ÙˆÚ© Ùˆ Ø´ÛŒØª  
    const ws = XLSX.utils.json_to_sheet(rows);  
    const wb = XLSX.utils.book_new();  
    XLSX.utils.book_append_sheet(wb, ws, "Ú¯Ø²Ø§Ø±Ø´ Ø­Ø¶ÙˆØ±");  
  
    // Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Excel Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯  
    XLSX.writeFile(wb, "attendance_report.xlsx");  
  });  
  
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡  
  (function init() {  
    const history = readHistory();  
    buildDateSelect(history);  
    renderTable(); // Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡  
  })();  
</script>  </body>  
</html>
