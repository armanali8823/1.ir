<!DOCTYPE html>

<html lang="fa">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <title>سامانه حضور و غیاب شرکت گسترده کام پویا جهش</title>  
  <style>  
    body {  
      font-family: Tahoma, sans-serif;  
      direction: rtl;  
      background-color: #f0f0f0;  
      padding: 20px;  
      text-align: center;  
    }  
    h2 { margin-bottom: 10px; }  
    table {  
      width: 100%;  
      border-collapse: collapse;  
      background: white;  
      margin-bottom: 20px;  
      table-layout: fixed;  
    }  
    th, td {  
      border: 1px solid #ccc;  
      padding: 8px 6px;  
      font-size: 14px;  
      vertical-align: middle;  
      word-wrap: break-word;  
    }  
    th {  
      background-color: #eee;  
    }  
    .btn {  
      padding: 6px 10px;  
      font-size: 13px;  
      border: none;  
      border-radius: 4px;  
      cursor: pointer;  
      user-select: none;  
      margin: 2px;  
    }  
    .btn:active { transform: scale(0.95); }  
    .delete-btn { background-color: #a50014; color: white; }  
    .status-btn { background-color: #ccc; color: #000; }  
    .status-btn.active1 { background-color: #158b00; color: white; }  
    .status-btn.active { background-color: #a50014; color: white; }  
    .save-btn {  
      background-color: #4caf50;  
      color: white;  
      font-size: 12px;  
      padding: 6px 12px;  
      border: none;  
      border-radius: 6px;  
      cursor: pointer;  
      float: left;  
      margin-bottom: 10px;  
      user-select: none;  
    }  
    .add-form {  
      background: white;  
      padding: 10px 12px;  
      border-radius: 8px;  
      box-shadow: 0 0 5px rgba(0,0,0,0.1);  
      max-width: 420px;  
      margin: 0 auto;  
      text-align: left;  
    }  
    .add-form input {  
      width: 120px;  
      padding: 6px;  
      font-size: 13px;  
      margin-left: 8px;  
      border: 1px solid #ccc;  
      border-radius: 5px;  
      text-align: center;  
    }  
    .add-form button.add-btn {  
      width: 90px;  
      padding: 6px 10px;  
      font-size: 13px;  
      background-color: #4caf50;  
      color: white;  
      border: none;  
      border-radius: 6px;  
      cursor: pointer;  
      margin-left: 8px;  
    }  
    /* تنظیمات بخش ورود و خروج و دکمه ثبت کنار آن */  
    .time-cell div {  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      gap: 6px;  
    }  
    .time-cell input {  
      width: 60px;  
      padding: 6px 8px;  
      font-size: 0.9rem;  
      border-radius: 5px;  
      border: 1px solid #ccc;  
      text-align: center;  
      flex-shrink: 0;  
    }  
    .time-register-btn {  
      padding: 4px 8px;  
      font-size: 12px;  
      cursor: pointer;  
      border-radius: 5px;  
      border: 1px solid #4caf50;  
      background-color: #a5d6a7;  
      color: #2e7d32;  
      user-select: none;  
      flex-shrink: 0;  
      transition: background-color 0.3s;  
    }  
    .time-register-btn:hover {  
      background-color: #81c784;  
    }  
    /* استایل دکمه بازگشت */  
    #backBtn {  
      margin-bottom: 15px;  
      padding: 6px 12px;  
      font-size: 14px;  
      border-radius: 6px;  
      border: 1px solid #ccc;  
      cursor: pointer;  
      background-color: #2196f3;  
      user-select: none;
        
    }  
    #backBtn:hover {  
      background-color: #ddd;
      text-color: white;
    } 
    /* استایل کانتینر تاریخ و دکمه ثبت */  
    #dateContainer {  
      margin-bottom: 20px;  
      display: inline-flex;  
      align-items: center;  
      gap: 8px;  
      justify-content: center;  
      width: 100%;  
    }  
    #dateInput {  
      width: 180px;  
      padding: 8px;  
      font-size: 14px;  
      border-radius: 6px;  
      border: 1px solid #ccc;  
      text-align: center;  
    }  
    #registerDateBtn {  
      width: 90px;  
      height: 34px;  
      padding: 0;  
    }  
  </style>  
</head>  
<body>  
  <a href="1.html"><button id="backBtn" onclick="history.back()">← بازگشت</button></a>

  <h2>حضور و غیاب شرکت گسترده کام پویا جهش</h2>    <div id="dateContainer">  
    <input type="text" id="dateInput" placeholder="مثلاً 1404/05/17" />  
    <button class="save-btn" id="registerDateBtn" onclick="registerDate()">ثبت تاریخ</button>  
  </div>    <table>  
    <thead>  
      <tr>  
        <th>ردیف</th>  
        <th>نام</th>  
        <th>شغل</th>  
        <th>ورود</th>  
        <th>خروج</th>  
        <th>حاضر</th>  
        <th>غایب</th>  
        <th>عملیات</th>  
      </tr>  
    </thead>  
    <tbody id="employeeTable"></tbody>  
  </table>  <button class="save-btn" onclick="saveFinalData()">💾 ذخیره گزارش روزانه</button>

  <div class="add-form">  
    <input type="text" id="nameInput" placeholder="نام کارمند" />  
    <input type="text" id="jobInput" placeholder="شغل کارمند" />  
    <button class="add-btn" onclick="addEmployee()">➕ افزودن</button>  
  </div>  <script>  
  let employees = JSON.parse(localStorage.getItem('employeeList')) || [];  
  
  function saveAndRender() {  
    localStorage.setItem('employeeList', JSON.stringify(employees));  
    renderTable();  
  }  
  
  function renderTable() {  
    const table = document.getElementById('employeeTable');  
    table.innerHTML = '';  
    employees.forEach((emp, index) => {  
      const row = document.createElement('tr');  
      row.innerHTML = `  
        <td>${index + 1}</td>  
        <td>${emp.name}</td>  
        <td>${emp.job}</td>  
        <td class="time-cell">  
          <div>  
            <input type="text" value="${emp.enter}" oninput="updateEnter(${index}, this.value)" ${emp.enter === '-' ? 'disabled' : ''} placeholder="مثلاً 9:00" id="enterInput${index}" />  
            <button class="time-register-btn" onclick="registerCurrentTime(${index}, 'enter')">ثبت</button>  
          </div>  
        </td>  
        <td class="time-cell">  
          <div>  
            <input type="text" value="${emp.exit}" oninput="updateExit(${index}, this.value)" ${emp.exit === '-' ? 'disabled' : ''} placeholder="مثلاً 17:00" id="exitInput${index}" />  
            <button class="time-register-btn" onclick="registerCurrentTime(${index}, 'exit')">ثبت</button>  
          </div>  
        </td>  
        <td><button class="btn status-btn ${emp.status === 'present' ? 'active1' : ''}" onclick="markStatus(${index}, 'present')">✔ حاضر</button></td>  
        <td><button class="btn status-btn ${emp.status === 'absent' ? 'active' : ''}" onclick="markStatus(${index}, 'absent')">✖ غایب</button></td>  
        <td>  
          <button class="btn edit-btn" onclick="toggleEditRow(${index}, this)">✏️ ویرایش</button>  
          <button class="btn delete-btn" onclick="deleteEmployee(${index})">🗑 حذف</button>  
        </td>  
      `;  
      table.appendChild(row);  
    });  
  }  
  
  // ثبت زمان فعلی سیستم به صورت HH:MM در فیلد ورود یا خروج  
  function registerCurrentTime(index, field) {  
    const now = new Date();  
    const hh = ('0' + now.getHours()).slice(-2);  
    const mm = ('0' + now.getMinutes()).slice(-2);  
    const timeStr = `${hh}:${mm}`;  
  
    if (field === 'enter') {  
      employees[index].enter = timeStr;  
      document.getElementById(`enterInput${index}`).value = timeStr;  
    } else if (field === 'exit') {  
      employees[index].exit = timeStr;  
      document.getElementById(`exitInput${index}`).value = timeStr;  
    }  
    saveToLocal();  
  }  
  
  function toggleEditRow(index, btn) {  
    const row = document.querySelectorAll('#employeeTable tr')[index];  
    if (!row) return;  
  
    const editMode = btn.textContent === '✔ ذخیره';  
  
    if (editMode) {  
      const nameInput = row.cells[1].querySelector('input');  
      const jobInput = row.cells[2].querySelector('input');  
      if (!nameInput.value.trim() || !jobInput.value.trim()) {  
        alert('نام و شغل نمی‌توانند خالی باشند!');  
        return;  
      }  
      employees[index].name = nameInput.value.trim();  
      employees[index].job = jobInput.value.trim();  
  
      const enterInput = row.cells[3].querySelector('input');  
      const exitInput = row.cells[4].querySelector('input');  
      employees[index].enter = enterInput.value.trim();  
      employees[index].exit = exitInput.value.trim();  
  
      saveAndRender();  
      btn.textContent = '✏️ ویرایش';  
    } else {  
      const nameTd = row.cells[1];  
      const jobTd = row.cells[2];  
      nameTd.innerHTML = `<input type="text" value="${employees[index].name}">`;  
      jobTd.innerHTML = `<input type="text" value="${employees[index].job}">`;  
      btn.textContent = '✔ ذخیره';  
    }  
  }  
  
  function updateEnter(index, value) {  
    employees[index].enter = value;  
    saveToLocal();  
  }  
  
  function updateExit(index, value) {  
    employees[index].exit = value;  
    saveToLocal();  
  }  
  
  function addEmployee() {  
    const name = document.getElementById('nameInput').value.trim();  
    const job = document.getElementById('jobInput').value.trim();  
  
    if (!name || !job) {  
      alert("لطفاً نام و شغل را وارد کنید.");  
      return;  
    }  
  
    const exists = employees.some(emp => emp.name.toLowerCase() === name.toLowerCase());  
    if (exists) {  
      alert("کارمند با این نام قبلاً ثبت شده است.");  
      return;  
    }  
  
    employees.push({ name, job, enter: '', exit: '', status: '' });  
    document.getElementById('nameInput').value = '';  
    document.getElementById('jobInput').value = '';  
    saveAndRender();  
  }  
  
  function markStatus(index, status) {  
    employees[index].status = status;  
    if (status === 'absent') {  
      employees[index].enter = '-';  
      employees[index].exit = '-';  
    } else {  
      if (employees[index].enter === '-') employees[index].enter = '';  
      if (employees[index].exit === '-') employees[index].exit = '';  
    }  
    saveAndRender();  
  }  
  
  function deleteEmployee(index) {  
    if (confirm("آیا مطمئن هستید؟")) {  
      employees.splice(index, 1);  
      saveAndRender();  
    }  
  }  
  
  function saveToLocal() {  
    localStorage.setItem('employeeList', JSON.stringify(employees));  
  }  
  
  function saveFinalData() {  
    const date = document.getElementById('dateInput').value.trim();  
    if (!date) {  
      alert("لطفاً تاریخ را وارد کنید.");  
      return;  
    }  
    let history = JSON.parse(localStorage.getItem('attendanceHistory')) || {};  
    history[date] = [...employees];  
    localStorage.setItem('attendanceHistory', JSON.stringify(history));  
    alert("✅ گزارش روزانه ذخیره شد برای تاریخ: " + date);  
  }  
  
  // گرفتن تاریخ شمسی امروز به صورت yyyy/mm/dd  
  function getTodayPersianDate() {  
    const today = new Date();  
    const options = { year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'persian' };  
    try {  
      return new Intl.DateTimeFormat('fa-IR-u-ca-persian', options).format(today);  
    } catch {  
      const y = today.getFullYear();  
      const m = ('0' + (today.getMonth() + 1)).slice(-2);  
      const d = ('0' + today.getDate()).slice(-2);  
      return `${y}/${m}/${d}`;  
    }  
  }  
  
  function registerDate() {  
    const dateInput = document.getElementById('dateInput');  
    const persianDate = getTodayPersianDate();  
    dateInput.value = persianDate;  
  
    localStorage.setItem('registeredDate', persianDate);  
    alert("تاریخ خودکار ثبت شد: " + persianDate);  
  }  
  
  renderTable();  
</script>  </body>  
</html>  
