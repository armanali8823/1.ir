<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>سامانه کدگذاری وسایل شرکت گسترده کام پویا جهش</title>
<style>
  body {
    font-family: Tahoma, sans-serif;
    direction: rtl;
    background-color: #f0f0f0;
    padding: 20px;
    text-align: center;
  }
  .container {
    background: #fff;
    max-width: 700px;
    margin: 20px auto;
    padding: 25px 30px;
    border-radius: 10px;
    box-shadow: 0 0 10px #ccc;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }
  label {
    font-weight: bold;
    margin-bottom: 5px;
  }
  input {
    padding: 7px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    width: 100%;
    direction: ltr;
    box-sizing: border-box;
  }
  button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 9px 18px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    align-self: center;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  button.search-btn {
    background-color: #0288d1;
    margin-bottom: 10px;
    padding: 10px 25px;
  }
  button.export-btn {
    background-color: #f57c00;
    margin-bottom: 20px;
    padding: 10px 25px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 8px;
    font-size: 14px;
  }
  th {
    background: #eee;
  }
  .action-btn {
    background-color: #2196F3;
    border: none;
    color: white;
    padding: 5px 10px;
    margin: 2px;
    border-radius: 4px;
    cursor: pointer;
  }
  .delete-btn {
    background-color: #f44336;
  }
  .save-btn {
    background-color: #4caf50;
  }
  .cancel-btn {
    background-color: #9e9e9e;
  }
</style>

<!-- افزودن کتابخانه SheetJS برای اکسل -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

</head>
<body>

<h2>کدگذاری وسایل شرکت گسترده کام پویا جهش</h2>

<button class="search-btn" type="button" onclick="searchItems()">🔍 جستجو</button>
<button class="export-btn" type="button" onclick="exportToExcel()">📥 خروجی اکسل</button>

<div class="container">
  <form id="itemForm" onsubmit="return addItem(event)">
    <label for="shelfNumber">شماره قفسه:</label>
    <input type="text" id="shelfNumber" name="shelfNumber" required />

    <label for="itemNumber">شماره وسیله:</label>
    <input type="number" id="itemNumber" name="itemNumber" required />

    <label for="itemQuantity">مقدار:</label>
    <input type="number" id="itemQuantity" name="itemQuantity" placeholder="" min="0" step="any" />

    <label for="itemUnit">واحد:</label>
    <input type="text" id="itemUnit" name="itemUnit" placeholder="" />

    <label for="itemName">نام وسیله:</label>
    <input type="text" id="itemName" name="itemName" required />

    <label for="itemModel">مدل وسیله:</label>
    <input type="text" id="itemModel" name="itemModel" />

    <button type="submit" title="ثبت وسیله">ثبت وسیله ➕</button>
  </form>
</div>

<table id="itemsTable" dir="rtl">
  <thead>
    <tr>
      <th>کد وسیله</th>
      <th>شماره قفسه</th>
      <th>شماره وسیله</th>
      <th>مقدار</th>
      <th>واحد</th>
      <th>نام وسیله</th>
      <th>مدل وسیله</th>
      <th>عملیات</th>
    </tr>
  </thead>
  <tbody>
    <!-- ردیف ها اینجا اضافه میشن -->
  </tbody>
</table>

<script>
  let items = [];
  let nextId = 1;

  function addItem(event) {
    event.preventDefault();

    const shelfNumber = document.getElementById('shelfNumber').value.trim();
    const itemNumber = document.getElementById('itemNumber').value.trim();
    const itemQuantity = document.getElementById('itemQuantity').value.trim();
    const itemUnit = document.getElementById('itemUnit').value.trim();
    const itemName = document.getElementById('itemName').value.trim();
    const itemModel = document.getElementById('itemModel').value.trim();

    if (!shelfNumber || !itemNumber || !itemName) {
      alert('لطفا فیلدهای ضروری را پر کنید.');
      return false;
    }

    items.push({
      id: nextId++,
      shelfNumber,
      itemNumber,
      itemQuantity,
      itemUnit,
      itemName,
      itemModel
    });

    renderTable(items);
    event.target.reset();
    return false;
  }

  function renderTable(list) {
    const tbody = document.querySelector('#itemsTable tbody');
    tbody.innerHTML = '';

    list.forEach(item => {
      if (item.isEditing) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.id}</td>
          <td><input type="text" id="edit_shelfNumber_${item.id}" value="${item.shelfNumber}" /></td>
          <td><input type="number" id="edit_itemNumber_${item.id}" value="${item.itemNumber}" /></td>
          <td><input type="number" id="edit_itemQuantity_${item.id}" value="${item.itemQuantity || ''}" step="any" min="0" /></td>
          <td><input type="text" id="edit_itemUnit_${item.id}" value="${item.itemUnit || ''}" /></td>
          <td><input type="text" id="edit_itemName_${item.id}" value="${item.itemName}" /></td>
          <td><input type="text" id="edit_itemModel_${item.id}" value="${item.itemModel || ''}" /></td>
          <td>
            <button class="action-btn save-btn" onclick="saveEdit(${item.id})">ذخیره</button>
            <button class="action-btn cancel-btn" onclick="cancelEdit(${item.id})">انصراف</button>
          </td>
        `;
        tbody.appendChild(tr);
      } else {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.shelfNumber}</td>
          <td>${item.itemNumber}</td>
          <td>${item.itemQuantity || '-'}</td>
          <td>${item.itemUnit || '-'}</td>
          <td>${item.itemName}</td>
          <td>${item.itemModel || '-'}</td>
          <td>
            <button class="action-btn" onclick="startEdit(${item.id})">ویرایش</button>
            <button class="action-btn delete-btn" onclick="deleteItem(${item.id})">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    });
  }

  function deleteItem(id) {
    if(confirm('آیا مطمئن هستید که می‌خواهید این مورد را حذف کنید؟')) {
      items = items.filter(i => i.id !== id);
      renderTable(items);
    }
  }

  function startEdit(id) {
    items = items.map(i => {
      if(i.id === id) {
        return {...i, isEditing: true};
      }
      return {...i, isEditing: false};
    });
    renderTable(items);
  }

  function cancelEdit(id) {
    items = items.map(i => {
      if(i.id === id) {
        const copy = {...i};
        delete copy.isEditing;
        return copy;
      }
      return i;
    });
    renderTable(items);
  }

  function saveEdit(id) {
    const shelfNumber = document.getElementById(`edit_shelfNumber_${id}`).value.trim();
    const itemNumber = document.getElementById(`edit_itemNumber_${id}`).value.trim();
    const itemQuantity = document.getElementById(`edit_itemQuantity_${id}`).value.trim();
    const itemUnit = document.getElementById(`edit_itemUnit_${id}`).value.trim();
    const itemName = document.getElementById(`edit_itemName_${id}`).value.trim();
    const itemModel = document.getElementById(`edit_itemModel_${id}`).value.trim();

    if (!shelfNumber || !itemNumber || !itemName) {
      alert('لطفا فیلدهای ضروری را پر کنید.');
      return;
    }

    items = items.map(i => {
      if(i.id === id) {
        return {
          id,
          shelfNumber,
          itemNumber,
          itemQuantity,
          itemUnit,
          itemName,
          itemModel
        };
      }
      return i;
    });

    renderTable(items);
  }

  function searchItems() {
    const searchTerm = prompt('شماره قفسه، نام وسیله، مقدار یا واحد برای جستجو را وارد کنید:');
    if (searchTerm !== null) {
      const term = searchTerm.trim().toLowerCase();
      const filtered = items.filter(i =>
        i.shelfNumber.toLowerCase().includes(term) ||
        i.itemName.toLowerCase().includes(term) ||
        (i.itemQuantity && i.itemQuantity.toString().toLowerCase().includes(term)) ||
        (i.itemUnit && i.itemUnit.toLowerCase().includes(term))
      );
      if(filtered.length === 0){
        alert('موردی پیدا نشد.');
      }
      renderTable(filtered);
    }
  }

  function exportToExcel() {
    if(items.length === 0) {
      alert('هیچ داده‌ای برای خروجی وجود ندارد.');
      return;
    }

    const ws_data = [
      ['کد وسیله', 'شماره قفسه', 'شماره وسیله', 'مقدار', 'واحد', 'نام وسیله', 'مدل وسیله']
    ];

    items.forEach(item => {
      ws_data.push([
        item.id,
        item.shelfNumber,
        item.itemNumber,
        item.itemQuantity || '',
        item.itemUnit || '',
        item.itemName,
        item.itemModel || ''
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    const range = XLSX.utils.decode_range(ws['!ref']);

    // استایل دادن به هدرها (پررنگ و وسط چین و پس‌زمینه خاکستری)
    for(let C = range.s.c; C <= range.e.c; ++C) {
      const cell_address = XLSX.utils.encode_cell({r:0, c:C});
      if(!ws[cell_address]) continue;
      ws[cell_address].s = {
        font: { bold: true },
        fill: { fgColor: { rgb: "DDDDDD" } },
        alignment: { horizontal: "center", vertical: "center" },
        border: {
          top: {style:"thin", color: {auto:1}},
          right: {style:"thin", color: {auto:1}},
          bottom: {style:"thin", color: {auto:1}},
          left: {style:"thin", color: {auto:1}}
        }
      };
    }

    // راست چین کردن داده ها (سطرهای بعد از هدر)
    for(let R = 1; R <= range.e.r; ++R) {
      for(let C = range.s.c; C <= range.e.c; ++C) {
        const cell_address = XLSX.utils.encode_cell({r:R, c:C});
        if(!ws[cell_address]) continue;
        ws[cell_address].s = {
          alignment: { horizontal: "right", vertical: "center" },
          border: {
            top: {style:"thin", color: {auto:1}},
            right: {style:"thin", color: {auto:1}},
            bottom: {style:"thin", color: {auto:1}},
            left: {style:"thin", color: {auto:1}}
          }
        };
      }
    }

    ws['!cols'] = [
      {wch: 10}, // کد وسیله
      {wch: 15}, // شماره قفسه
      {wch: 15}, // شماره وسیله
      {wch: 10}, // مقدار
      {wch: 10}, // واحد
      {wch: 25}, // نام وسیله
      {wch: 20}  // مدل وسیله
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'وسایل');

    XLSX.writeFile(wb, 'items_export.xlsx');
  }
</script>

</body>
</html>
