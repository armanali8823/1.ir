<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>سامانه کدگذاری وسایل بر اساس قفسه</title>
<style>
  body {
    font-family: Tahoma, sans-serif;
    direction: rtl;
    background-color: #f0f0f0;
    padding: 20px;
    text-align: center;
  }
  .container {
    background: #fff;
    max-width: 700px;
    margin: 20px auto;
    padding: 25px 30px;
    border-radius: 10px;
    box-shadow: 0 0 10px #ccc;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }
  label {
    font-weight: bold;
    margin-bottom: 5px;
  }
  input {
    padding: 7px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    width: 100%;
    direction: ltr;
    box-sizing: border-box;
  }
  button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 9px 18px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    align-self: center;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  button.search-btn {
    background-color: #0288d1;
    margin-bottom: 10px;
    padding: 10px 25px;
  }
  button.export-btn {
    background-color: #f57c00;
    margin-bottom: 20px;
    padding: 10px 25px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #aaa;
    padding: 8px;
    font-size: 14px;
  }
  th {
    background: #eee;
  }
</style>
</head>
<body>

<h2>سامانه کدگذاری وسایل بر اساس قفسه</h2>

<button class="search-btn" type="button" onclick="searchItems()">🔍 جستجو</button>
<button class="export-btn" type="button" onclick="exportToExcel()">📥 خروجی اکسل</button>

<div class="container">
  <form id="itemForm" onsubmit="return addItem(event)">
    <label for="shelfNumber">شماره قفسه:</label>
    <input type="text" id="shelfNumber" name="shelfNumber" required />

    <label for="itemNumber">شماره وسیله:</label>
    <input type="number" id="itemNumber" name="itemNumber" required />

    <label for="itemQuantity">مقدار:</label>
    <input type="number" id="itemQuantity" name="itemQuantity" placeholder="" min="0" step="any" />

    <label for="itemUnit">واحد:</label>
    <input type="text" id="itemUnit" name="itemUnit" placeholder="" />

    <label for="itemName">نام وسیله:</label>
    <input type="text" id="itemName" name="itemName" required />

    <label for="itemModel">مدل وسیله:</label>
    <input type="text" id="itemModel" name="itemModel" />

    <button type="submit" title="ثبت وسیله">ثبت وسیله ➕</button>
  </form>
</div>

<table id="itemsTable" dir="rtl">
  <thead>
    <tr>
      <th>کد وسیله</th>
      <th>شماره قفسه</th>
      <th>شماره وسیله</th>
      <th>مقدار</th>
      <th>واحد</th>
      <th>نام وسیله</th>
      <th>مدل وسیله</th>
      <th>عملیات</th>
    </tr>
  </thead>
  <tbody>
    <!-- ردیف ها اینجا اضافه میشن -->
  </tbody>
</table>

<script>
  let items = [];
  let nextId = 1;

  function addItem(event) {
    event.preventDefault();

    const shelfNumber = document.getElementById('shelfNumber').value.trim();
    const itemNumber = document.getElementById('itemNumber').value.trim();
    const itemQuantity = document.getElementById('itemQuantity').value.trim();
    const itemUnit = document.getElementById('itemUnit').value.trim();
    const itemName = document.getElementById('itemName').value.trim();
    const itemModel = document.getElementById('itemModel').value.trim();

    if (!shelfNumber || !itemNumber || !itemName) {
      alert('لطفا فیلدهای ضروری را پر کنید.');
      return false;
    }

    items.push({
      id: nextId++,
      shelfNumber,
      itemNumber,
      itemQuantity,
      itemUnit,
      itemName,
      itemModel
    });

    renderTable(items);
    event.target.reset();
    return false;
  }

  function renderTable(list) {
    const tbody = document.querySelector('#itemsTable tbody');
    tbody.innerHTML = '';

    list.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${item.shelfNumber}</td>
        <td>${item.itemNumber}</td>
        <td>${item.itemQuantity || '-'}</td>
        <td>${item.itemUnit || '-'}</td>
        <td>${item.itemName}</td>
        <td>${item.itemModel || '-'}</td>
        <td><button onclick="deleteItem(${item.id})">حذف</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteItem(id) {
    items = items.filter(i => i.id !== id);
    renderTable(items);
  }

  function searchItems() {
    const searchTerm = prompt('شماره قفسه، نام وسیله، مقدار یا واحد برای جستجو را وارد کنید:');
    if (searchTerm !== null) {
      const term = searchTerm.trim().toLowerCase();
      const filtered = items.filter(i =>
        i.shelfNumber.toLowerCase().includes(term) ||
        i.itemName.toLowerCase().includes(term) ||
        (i.itemQuantity && i.itemQuantity.toString().toLowerCase().includes(term)) ||
        (i.itemUnit && i.itemUnit.toLowerCase().includes(term))
      );
      if(filtered.length === 0){
        alert('موردی پیدا نشد.');
      }
      renderTable(filtered);
    }
  }

  function exportToExcel() {
    if(items.length === 0) {
      alert('هیچ داده‌ای برای خروجی وجود ندارد.');
      return;
    }
    const headers = ['کد وسیله', 'شماره قفسه', 'شماره وسیله', 'مقدار', 'واحد', 'نام وسیله', 'مدل وسیله'];
    const rows = items.map(item => [
      item.id,
      item.shelfNumber,
      item.itemNumber,
      item.itemQuantity || '',
      item.itemUnit || '',
      item.itemName,
      item.itemModel || ''
    ]);

    let csvContent = '\uFEFF'; // BOM for Excel UTF-8
    csvContent += headers.join(',') + '\n';

    rows.forEach(rowArray => {
      // اگر هر فیلد شامل کاما بود، با "" دورش می‌کنیم
      const row = rowArray.map(field => {
        if (typeof field === 'string' && field.includes(',')) {
          return `"${field}"`;
        }
        return field;
      }).join(',');
      csvContent += row + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'items_export.csv';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>

</body>
</html>
